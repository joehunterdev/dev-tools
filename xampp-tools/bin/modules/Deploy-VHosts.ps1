# Name: Deploy VHosts
# Description: Build & deploy virtual hosts + hosts file
# Icon: üåê
# Cmd: deploy-vhosts
# Order: 7

<#
.SYNOPSIS
    Deploy VHosts - Build virtual hosts from vhosts.json

.DESCRIPTION
    1. Reads site definitions from config/vhosts.json
    2. Validates document root folders exist
    3. Generates httpd-vhosts.conf to dist/
    4. Optionally deploys to XAMPP
#>

# Get paths
$moduleRoot = Split-Path (Split-Path $PSScriptRoot -Parent) -Parent
. (Join-Path $moduleRoot "bin\Common.ps1")

# ============================================================
# CONFIGURATION
# ============================================================

$script:EnvFile = Join-Path $moduleRoot ".env"
$script:Config = Load-FilesConfig $moduleRoot

if (-not $script:Config) {
    Write-Error2 "Could not load config/config.json"
    exit
}

$script:TemplatesDir = Join-Path $moduleRoot $script:Config.templates.sourceDir
$script:DistDir = Join-Path $moduleRoot $script:Config.templates.distDir
$script:VhostsFile = Join-Path $moduleRoot $script:Config.vhosts.sitesFile

# ============================================================
# FUNCTIONS
# ============================================================

function Get-VhostBlock {
    param(
        [string]$BlocksContent,
        [string]$AppType,
        [bool]$Https
    )
    
    $httpsStr = if ($Https) { "true" } else { "false" }
    $pattern = "## App:$AppType HTTPS:$httpsStr"
    
    $lines = $BlocksContent -split "`n"
    $inBlock = $false
    $blockLines = @()
    
    for ($i = 0; $i -lt $lines.Count; $i++) {
        $line = $lines[$i]
        
        if ($line -match [regex]::Escape($pattern)) {
            $inBlock = $true
            continue
        }
        
        if ($inBlock) {
            if ($line -match "^##") {
                break
            }
            $blockLines += $line
        }
    }
    
    return ($blockLines -join "`n").Trim()
}

function Test-SiteFolder {
    param(
        [string]$DocumentRoot,
        [string]$Folder,
        [string]$Type
    )
    
    $basePath = Join-Path $DocumentRoot $Folder
    
    # Laravel needs public subfolder
    if ($Type.ToLower() -eq "laravel") {
        $checkPath = Join-Path $basePath "public"
    } else {
        $checkPath = $basePath
    }
    
    return @{
        Exists = Test-Path $checkPath
        Path = $checkPath
        BasePath = $basePath
    }
}

function Build-VhostsConfig {
    param(
        [hashtable]$EnvVars,
        [array]$ValidSites
    )
    
    $blocksTemplatePath = Join-Path $script:TemplatesDir $script:Config.vhosts.blocksTemplate
    $outputPath = Join-Path $script:DistDir $script:Config.vhosts.output
    
    if (-not (Test-Path $blocksTemplatePath)) {
        return @{ Success = $false; Error = "Blocks template not found: $($script:Config.vhosts.blocksTemplate)" }
    }
    
    try {
        $blocksContent = Get-Content $blocksTemplatePath -Raw
        
        $output = @()
        $output += "# Apache VHosts Configuration"
        $output += "# Generated by xampp-tools - DO NOT EDIT DIRECTLY"
        $output += "# Edit config/vhosts.json and regenerate"
        $output += "# Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        $output += ""
        
        # Always add default localhost catch-all
        $output += "# Default (localhost)"
        $defaultBlock = Get-VhostBlock -BlocksContent $blocksContent -AppType "Default" -Https $false
        if ($defaultBlock) {
            $port = if ($EnvVars['XAMPP_SERVER_PORT']) { $EnvVars['XAMPP_SERVER_PORT'] } else { "80" }
            $sslPort = if ($EnvVars['XAMPP_SSL_PORT']) { $EnvVars['XAMPP_SSL_PORT'] } else { "443" }
            $docRoot = if ($EnvVars['XAMPP_DOCUMENT_ROOT']) { $EnvVars['XAMPP_DOCUMENT_ROOT'] } else { "C:\www" }
            $xamppRoot = if ($EnvVars['XAMPP_ROOT_DIR']) { $EnvVars['XAMPP_ROOT_DIR'] } else { "C:\xampp" }
            
            $defaultBlock = $defaultBlock -replace "{{PORT}}", $port
            $defaultBlock = $defaultBlock -replace "{{SSL_PORT}}", $sslPort
            $defaultBlock = $defaultBlock -replace "{{SERVER_NAME}}", "localhost"
            $defaultBlock = $defaultBlock -replace "{{FOLDER}}", "."
            $defaultBlock = $defaultBlock -replace "{{NAME}}", "Default (localhost)"
            $defaultBlock = $defaultBlock -replace "{{DOCUMENT_ROOT}}", $docRoot
            $defaultBlock = $defaultBlock -replace "{{XAMPP_ROOT_DIR}}", $xamppRoot
            
            $output += $defaultBlock
            $output += ""
        } else {
            # Fallback if template block not found
            $port = if ($EnvVars['XAMPP_SERVER_PORT']) { $EnvVars['XAMPP_SERVER_PORT'] } else { "80" }
            $docRoot = if ($EnvVars['XAMPP_DOCUMENT_ROOT']) { $EnvVars['XAMPP_DOCUMENT_ROOT'] } else { "C:\www" }
            $output += "<VirtualHost *:$port>"
            $output += "    ServerName localhost"
            $output += "    DocumentRoot `"$docRoot`""
            $output += "    <Directory `"$docRoot`">"
            $output += "        Options Indexes FollowSymLinks"
            $output += "        AllowOverride All"
            $output += "        Require all granted"
            $output += "        DirectoryIndex index.php index.html index.htm"
            $output += "    </Directory>"
            $output += "    ErrorLog `"logs/default-error.log`""
            $output += "    CustomLog `"logs/default-access.log`" common"
            $output += "</VirtualHost>"
            $output += ""
        }
        
        $port = if ($EnvVars['XAMPP_SERVER_PORT']) { $EnvVars['XAMPP_SERVER_PORT'] } else { "80" }
        $sslPort = if ($EnvVars['XAMPP_SSL_PORT']) { $EnvVars['XAMPP_SSL_PORT'] } else { "443" }
        $docRoot = if ($EnvVars['XAMPP_DOCUMENT_ROOT']) { $EnvVars['XAMPP_DOCUMENT_ROOT'] } else { "C:\www" }
        $xamppRoot = if ($EnvVars['XAMPP_ROOT_DIR']) { $EnvVars['XAMPP_ROOT_DIR'] } else { "C:\xampp" }
        $domainExt = if ($EnvVars['VHOSTS_EXTENSION']) { $EnvVars['VHOSTS_EXTENSION'] } else { ".local" }
        
        foreach ($site in $ValidSites) {
            $appType = switch ($site.type.ToLower()) {
                "default" { "Default" }
                "laravel" { "Laravel" }
                "react" { "React" }
                "wordpress" { "WordPress" }
                "static" { "Static" }
                default { "Static" }
            }
            
            $https = if ($site.https) { $true } else { $false }
            
            # Generate server name: use serverName if specified, otherwise folder + extension
            if ($site.serverName) {
                $serverName = $site.serverName
            } else {
                $baseName = $site.folder -replace '\.[^.]+$', ''
                $serverName = "$baseName$domainExt"
            }
            
            $block = Get-VhostBlock -BlocksContent $blocksContent -AppType $appType -Https $https
            
            if ($block) {
                $block = $block -replace "{{PORT}}", $port
                $block = $block -replace "{{SSL_PORT}}", $sslPort
                $block = $block -replace "{{SERVER_NAME}}", $serverName
                $block = $block -replace "{{FOLDER}}", $site.folder
                $block = $block -replace "{{NAME}}", $site.name
                $block = $block -replace "{{DOCUMENT_ROOT}}", $docRoot
                $block = $block -replace "{{XAMPP_ROOT_DIR}}", $xamppRoot
                
                $output += "# $($site.name)"
                $output += $block
                $output += ""
            }
        }
        
        # Ensure output directory exists
        $outputDir = Split-Path $outputPath -Parent
        if (-not (Test-Path $outputDir)) {
            New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
        }
        
        Set-Content -Path $outputPath -Value ($output -join "`n")
        
        return @{ Success = $true; Count = $ValidSites.Count; OutputPath = $outputPath }
    } catch {
        return @{ Success = $false; Error = $_.Exception.Message }
    }
}

function Deploy-VhostsToXampp {
    param(
        [string]$SourcePath,
        [string]$XamppRoot
    )
    
    $targetPath = Join-Path $XamppRoot "apache\conf\extra\httpd-vhosts.conf"
    
    try {
        # Backup original if no backup exists
        if (Test-Path $targetPath) {
            $backupPath = "$targetPath.original"
            if (-not (Test-Path $backupPath)) {
                Copy-Item $targetPath $backupPath -Force
            }
        }
        
        Copy-Item $SourcePath $targetPath -Force
        return @{ Success = $true; TargetPath = $targetPath }
    } catch {
        return @{ Success = $false; Error = $_.Exception.Message }
    }
}

function Test-ApacheConfig {
    param([string]$XamppRoot)
    
    $httpdPath = Join-Path $XamppRoot "apache\bin\httpd.exe"
    if (-not (Test-Path $httpdPath)) {
        return @{ Success = $false; Error = "httpd.exe not found" }
    }
    
    try {
        $output = & $httpdPath -t 2>&1
        $exitCode = $LASTEXITCODE
        
        if ($exitCode -eq 0) {
            return @{ Success = $true; Output = $output }
        } else {
            return @{ Success = $false; Error = ($output -join "`n") }
        }
    } catch {
        return @{ Success = $false; Error = $_.Exception.Message }
    }
}

function Build-HostsFile {
    param(
        [array]$ValidSites,
        [hashtable]$EnvVars
    )
    
    $hostsOutputPath = Join-Path $script:DistDir $script:Config.vhosts.hostsOutput
    $domainExt = if ($EnvVars['VHOSTS_EXTENSION']) { $EnvVars['VHOSTS_EXTENSION'] } else { ".local" }
    
    try {
        $output = @()
        $output += "# Hosts file - Generated by xampp-tools"
        $output += "# Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        $output += "# DO NOT EDIT DIRECTLY - Edit config/vhosts.json and regenerate"
        $output += ""
        $output += "# Default localhost entries"
        $output += "127.0.0.1       localhost"
        $output += "::1             localhost"
        $output += ""
        $output += "# XAMPP Sites"
        
        foreach ($site in $ValidSites) {
            # Generate server name: use serverName if specified, otherwise folder + extension
            if ($site.serverName) {
                $serverName = $site.serverName
            } else {
                $baseName = $site.folder -replace '\.[^.]+$', ''
                $serverName = "$baseName$domainExt"
            }
            $output += "127.0.0.1       $serverName"
        }
        
        $output += ""
        $output += "# End of xampp-tools generated entries"
        
        # Ensure output directory exists
        $outputDir = Split-Path $hostsOutputPath -Parent
        if (-not (Test-Path $outputDir)) {
            New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
        }
        
        Set-Content -Path $hostsOutputPath -Value ($output -join "`n")
        
        return @{ Success = $true; OutputPath = $hostsOutputPath; Count = $ValidSites.Count }
    } catch {
        return @{ Success = $false; Error = $_.Exception.Message }
    }
}

function Deploy-HostsFile {
    param([string]$SourcePath)
    
    $targetPath = "C:\Windows\System32\drivers\etc\hosts"
    
    try {
        # Backup original if no backup exists
        if (Test-Path $targetPath) {
            $backupPath = "$targetPath.original"
            if (-not (Test-Path $backupPath)) {
                Copy-Item $targetPath $backupPath -Force
            }
        }
        
        Copy-Item $SourcePath $targetPath -Force
        return @{ Success = $true; TargetPath = $targetPath }
    } catch {
        return @{ Success = $false; Error = $_.Exception.Message }
    }
}

# ============================================================
# MAIN
# ============================================================

param(
    [switch]$Force
)

Show-Header

Write-Host ""
Write-Host "  üåê Deploy VHosts" -ForegroundColor Cyan
Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host ""

# Check .env
if (-not (Test-Path $script:EnvFile)) {
    Write-Error2 ".env file not found!"
    exit
}

# Check vhosts.json
if (-not (Test-Path $script:VhostsFile)) {
    Write-Error2 "vhosts.json not found!"
    exit
}

# Load env and vhosts
$envData = Load-EnvFile $script:EnvFile
$vhostsConfig = Get-Content $script:VhostsFile -Raw | ConvertFrom-Json

$docRoot = if ($envData.XAMPP_DOCUMENT_ROOT) { $envData.XAMPP_DOCUMENT_ROOT } else { "C:\www" }
$xamppRoot = if ($envData.XAMPP_ROOT_DIR) { $envData.XAMPP_ROOT_DIR } else { "C:\xampp" }

Write-Host "  Document Root: $docRoot" -ForegroundColor Gray
Write-Host ""

# Step 1: Validate sites
Write-Host "  Step 1: Validate site folders" -ForegroundColor White
Write-Host ""

$validSites = @()
$invalidSites = @()

foreach ($site in $vhostsConfig.vhosts) {
    $check = Test-SiteFolder -DocumentRoot $docRoot -Folder $site.folder -Type $site.type
    
    if ($check.Exists) {
        Write-Host "    ‚úÖ $($site.name)" -ForegroundColor Green
        Write-Host "       $($check.Path)" -ForegroundColor DarkGray
        $validSites += $site
    } else {
        Write-Host "    ‚ùå $($site.name)" -ForegroundColor Red
        Write-Host "       Missing: $($check.Path)" -ForegroundColor DarkGray
        $invalidSites += $site
    }
}

Write-Host ""
Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host ""

if ($validSites.Count -eq 0) {
    Write-Error2 "No valid sites found! Create the folders first."
    exit
}

Write-Host "  Valid: $($validSites.Count)  |  Invalid: $($invalidSites.Count)" -ForegroundColor Gray
Write-Host ""

if ($invalidSites.Count -gt 0) {
    Write-Host "  ‚ö†Ô∏è  Invalid sites will be skipped" -ForegroundColor Yellow
    Write-Host ""
}

# Step 2: Build vhosts
if (-not (Prompt-YesNo "  Build httpd-vhosts.conf with $($validSites.Count) site(s)?")) {
    Write-Host ""
    Write-Host "  Cancelled." -ForegroundColor Yellow
    exit
}

Write-Host ""
Write-Host "  Step 2: Building configs..." -ForegroundColor White
Write-Host ""

# Build vhosts
$buildResult = Build-VhostsConfig -EnvVars $envData -ValidSites $validSites

if (-not $buildResult.Success) {
    Write-Error2 "VHosts build failed: $($buildResult.Error)"
    exit
}

Write-Host "    ‚úÖ httpd-vhosts.conf ($($buildResult.Count) sites)" -ForegroundColor Green

# Build hosts file
$hostsResult = Build-HostsFile -ValidSites $validSites -EnvVars $envData

if (-not $hostsResult.Success) {
    Write-Error2 "Hosts build failed: $($hostsResult.Error)"
    exit
}

Write-Host "    ‚úÖ hosts ($($hostsResult.Count) entries)" -ForegroundColor Green

Write-Host ""
Write-Success "Built to dist/"

Write-Host ""
Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host ""

# Step 3: Deploy to XAMPP
Write-Host "  Step 3: Deploy to XAMPP" -ForegroundColor White
Write-Host "    ‚Ä¢ httpd-vhosts.conf -> $xamppRoot\apache\conf\extra\" -ForegroundColor Gray
Write-Host "    ‚Ä¢ hosts -> C:\Windows\System32\drivers\etc\" -ForegroundColor Gray
Write-Host ""

if (-not $Force -and -not (Prompt-YesNo "  Deploy to XAMPP? (requires admin for hosts)")) {
    Write-Host ""
    Write-Host "  Skipped deployment. Configs are in dist/" -ForegroundColor Yellow
    exit
}

Write-Host ""

# Deploy vhosts
$deployResult = Deploy-VhostsToXampp -SourcePath $buildResult.OutputPath -XamppRoot $xamppRoot

if (-not $deployResult.Success) {
    Write-Error2 "VHosts deploy failed: $($deployResult.Error)"
    exit
}

Write-Host "    ‚úÖ httpd-vhosts.conf" -ForegroundColor Green

# Deploy hosts (requires admin)
$hostsDeployResult = Deploy-HostsFile -SourcePath $hostsResult.OutputPath

if (-not $hostsDeployResult.Success) {
    Write-Host "    ‚ö†Ô∏è  hosts - $($hostsDeployResult.Error)" -ForegroundColor Yellow
    Write-Host "       Run as Administrator or copy manually from dist/" -ForegroundColor DarkGray
} else {
    Write-Host "    ‚úÖ hosts" -ForegroundColor Green
}

Write-Host ""
Write-Success "Deployed to XAMPP!"

Write-Host ""
Write-Host "  Step 4: Testing Apache config..." -ForegroundColor White
Write-Host ""

$testResult = Test-ApacheConfig -XamppRoot $xamppRoot

if ($testResult.Success) {
    Write-Success "Apache config syntax OK!"
    Write-Host ""
    Write-Host "  ‚ö†Ô∏è  Restart Apache to apply changes" -ForegroundColor Yellow
} else {
    Write-Error2 "Apache config test FAILED!"
    Write-Host ""
    Write-Host "  Error:" -ForegroundColor Red
    Write-Host "  $($testResult.Error)" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  ‚ö†Ô∏è  Restoring original config..." -ForegroundColor Yellow
    
    $originalPath = "$($deployResult.TargetPath).original"
    if (Test-Path $originalPath) {
        Copy-Item $originalPath $deployResult.TargetPath -Force
        Write-Success "Restored original config"
    }
}

Write-Host ""
